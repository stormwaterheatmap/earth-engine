/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var image = ee.Image(
    "projects/ee-stormwaterheatmap/assets/production/Mean_Annual_Q_8_epochs"
  ),
  table = ee.FeatureCollection(
    "projects/ee-stormwaterheatmap/assets/puget_LL_hydrology_bounds_fc"
  ),
  psau_fv = ui.Map.FeatureViewLayer(
    "projects/ee-stormwaterheatmap/assets/puget_LL_hydrology_bounds_fv",
    null,
    "puget_LL_hydrology_bounds_fv"
  ),
  psau = ee.FeatureCollection(
    "projects/ee-stormwaterheatmap/assets/puget_LL_hydrology_bounds_fc"
  ),
  runoff = ee.Image(
    "projects/ee-stormwaterheatmap/assets/production/Mean_Annual_Q_8_epochs"
  );
/***** End of imports. If edited, may not auto-convert in the playground. *****/
var data = require("users/stormwaterheatmap/apps:data/data_dictionary.js");
var Style = require("users/stormwaterheatmap/apps:Modules/Style");
var helpers = require("users/stormwaterheatmap/apps:Modules/helpers");
var fonts = Style.fonts;

print(Style);
var runoff_base = data.rasters["Runoff (mm)"];
var runoff_img = {eeObject:runoff_base.layer.eeObject, name:runoff_base.name, visParams: runoff_base.visParams};

//Export.image.toAsset({image:runoff_img,scale:5,region:table,maxPixels:1e12})
//Export.table.toDrive(table)

Map.addLayer(runoff_img);
// Set visualization properties for the defined layer.
psau_fv.setVisParams({
  //polygonStrokeType: 'dashed',
  polygonStrokeColor: "white",
  polygonStrokeOpacity: 1,
  polygonFillColor: "cadetBlue",
  polygonFillOpacity: 0.2,
  width: 1.5,
});

Map.add(psau_fv);

var panel = ui.Panel({
  style: {
    shown: false,
  },
});
Map.add(panel);

function map_click_callback(coords) {
  var pt = ee.Geometry.Point([coords.lon, coords.lat]);
  var shed = psau.filterBounds(pt);
  Map.layers().set(2, shed);
  var chart = make_chart(shed);
  panel.style().set({
    shown: true,
  });
  panel.widgets().set(0, chart);
}
Map.onClick(map_click_callback);

function make_chart(region) {
  var chart = ui.Chart.image.regions({
    image: runoff,
    regions: region,
    reducer: ee.Reducer.mean(),
    scale: 10,
    xLabels: [1980, 2030, 2040, 2050, 2060, 2070, 2080],
  });

  // Set chart style properties.
  var chartStyle = {
    title: "Estimated runoff over time",
    vAxis: {
      title: "Mean Annual Runoff (mm)",
    },
    hAxis: {
      title: "year",
      format: "####",
      viewWindow: {
        min: 1970,
        max: 2100,
      },
    },
    pointSize: 4,
    lineWidth: 0, 

    trendlines: {
      0: {
        // add a trend line to the 1st series
        type: "linear", // or 'polynomial', 'exponential'
        color: "green",
        lineWidth: 1,
        lineDashStyle: [4, 4],
        opacity: 0.8,
        //visibleInLegend: true,
      },
    },
  };
  return chart.setOptions(chartStyle);
}

helpers.make_tnc_map();

//Add side panel
var side_panel = ui.Panel({
  layout: ui.Panel.Layout.flow(),
  style: {
    width: "20%",
    height: "75%",
    position: "bottom-left",
    backgroundColor: "#4B5D6Ce6",
    color: "4B5D6C",
  },
});
var title = ui.Label({
  value: "How will runoff change in  Puget Sound?",
  style: {
    color: "white",
    fontSize: "30px",
    fontWeight: 700,
    backgroundColor: "#4B5D6C00",
  },
});
side_panel.add(title);
Map.add(side_panel);
